templates:
  - "templates/web.template.yml"
  - "templates/web.ratelimited.template.yml"
  # "templates/web.ssl.template.yml" is not needed/desired b/c we are terminating TLS on ALB

  - "templates/cloudflare.template.yml"
  - "alb_nginx_ip.yml"
  # should be written at runtime in Github Actions
  # ensures environmental variables are set correctly at bootstrap w/o showing them here
  - "secrets.yml"

expose:
  - "80:80" # http
  # - "443:443" # again, we termiante SSL on ALB... there shouldn't be any HTTPS traffic to this container, right....?

# no need for `links` since we are using RDS here
env:
  LC_ALL: en_US.UTF-8
  LANG: en_US.UTF-8
  LANGUAGE: en_US.UTF-8

  DISCOURSE_DB_USERNAME: postgres
  DISCOURSE_DB_HOST: db.discourse.internal # these are internal Route53 records
  DISCOURSE_DB_PORT: 5432
  DISCOURSE_REDIS_HOST: cache.discourse.internal
  DISCOURSE_REDIS_PORT: 6379

  DISCOURSE_S3_USE_IAM_PROFILE: true

  # must be true even though SSL is terminated at ALB so all content is served over HTTPS
  DISCOURSE_FORCE_HTTPS: true

  # https://meta.discourse.org/t/trouble-bootstrapping-with-rds-could-not-open-certificate-file/289367
  PGSSLCERT: /tmp/postgresql.crt
  # DISCOURSE_REDIS_USE_SSL: true  # this is required if cache is on Elasticache

  # DISCOURSE_CAN_PERMANENTLY_DELETE: true

  UNICORN_WORKERS: 4 # raise when we increase CPU size of instance

  DISCOURSE_USE_S3: true
  DISCOURSE_S3_REGION: us-west-2
  DISCOURSE_BACKUP_LOCATION: s3
  DISCOURSE_INCLUDE_S3_UPLOADS_IN_BACKUPS: true

  # reference for last octet: https://www.regular-expressions.info/ip.html
  # allows any instance in the private subnets (10.0.16.0/24, 10.0.17.0/24, etc) to connect
  DISCOURSE_PROMETHEUS_TRUSTED_IP_ALLOWLIST_REGEX: '^10\.0\.(?:1[6-9])\.(?:25[0-5]|2[0-4]\d|[01]?\d\d?)$'

params:
  version: tests-passed

volumes:
  - volume:
      host: /var/discourse/shared/web-only
      guest: /shared
  - volume:
      host: /var/discourse/shared/web-only/log/var-log
      guest: /var/log

hooks:
  after_code:
    - exec:
        cd: $home/plugins
        cmd:
          - sudo -E -u discourse git clone https://github.com/discourse/docker_manager.git
          - sudo -E -u discourse git clone https://github.com/discourse/discourse-category-experts.git
          - sudo -E -u discourse git clone https://github.com/discourse/discourse-perspective-api.git
          - sudo -E -u discourse git clone https://github.com/discourse/discourse-yearly-review.git
          - sudo -E -u discourse git clone https://github.com/discourse/discourse-cakeday.git
          - sudo -E -u discourse git clone https://github.com/discourse/discourse-saved-searches.git
          - sudo -E -u discourse git clone https://github.com/discourse/discourse-surveys.git
          - sudo -E -u discourse git clone https://github.com/discourse/discourse-prometheus.git
  after_assets_precompile: # https://meta.discourse.org/t/configure-an-s3-compatible-object-storage-provider-for-uploads/148916
    - exec:
        cd: $home
        cmd:
          - sudo -E -u discourse bundle exec rake s3:upload_assets
          - sudo -E -u discourse bundle exec rake s3:expire_missing_assets
